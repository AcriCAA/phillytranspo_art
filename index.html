<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<style>

.tracts {
    fill: #444;
    stroke: #444;
    opacity: 0.1;

    pointer-events: all;
}

circle {
  fill: #000;
  opacity: 0.2;
}

.is-twinkling {
  -webkit-animation-delay: 0;
  -webkit-animation-duration: 2s;
  -webkit-animation-name: twinkle;
}

@-webkit-keyframes twinkle {
  0% {
    opacity: 0;
    fill: white;
    /*stroke: black;*/
  }

  5% {
    opacity: 0.8;
    fill: yellow;
  }

  15% {
    opacity: 0.1;
    fill: silver;
  }

  20% {
    opacity: 0.6;
    fill: white;
  }

  100% {
    opacity: 0;
    fill: silver;
    /*stroke: white;*/
  }
}

</style>
</head>
<body>

<script src="d3.v3.min.js"></script>
<script src="topojson.v0.min.js"></script>
<script src="underscore.js"></script>
<script src="jquery.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> -->

<script>

var width = 960,
    height = 500;

var projection = d3.geo.mercator()
    .center([-75.16, 39.95])
    .scale(150000);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

var g2 = svg.append("g").attr('id', 'bikeshare');

var storedJson = null;

d3.json("tracts.topojson", function(error, topology) {
    g.selectAll("path")
        .data(topojson.object(topology, topology.objects.tracts).geometries)
      .enter().append("path")
        .attr("class", "tracts")
  .attr("id", function(d){return d.id;})
  .attr("d", path);
});

d3.json("bikeshare.geojson", function(error, json) {
    storedJson = json;
    g2.selectAll("circle")
        .data(json.features)
      .enter().append("circle")
        .attr("class", "bikeshare")
        .attr("transform", function(d) {
            return "translate(" + projection(d.geometry.coordinates) + ")"
          })
        .attr("r", function(d) {
            return 3;//d.properties.bikesAvailable;
          })
        .style('opacity', 0)
  .attr("d", path);

});

var allData = {}
  , sortedData = []
  , bikeIndex = 0;

$.ajax({
  url: 'es_logstash-phl-ind-2015.05.28',
  dataType: 'json',
  success: function(data) {
    data.forEach(function (d) {
      var key = d._source['@timestamp'].slice(0, 16);
      if (!allData[key]) { allData[key] = []; }
      allData[key].push(d);
    })

    _.keys(allData).sort().forEach(function(k) {
      sortedData.push(allData[k]);
    });

    setInterval(function() {
      if (bikeIndex >= sortedData.length) {
        bikeIndex = 0;
      }
      twinkleBikes(sortedData[bikeIndex]);
      bikeIndex++;
    }, 2000)
  }
});

function twinkleBikes(json) {
  var mappedJson = {};

  json.forEach(function(d) {
    mappedJson[d._source.properties.kioskId] = d;
  });

  g2.selectAll('circle')
    .classed('is-twinkling', false)
    .classed('is-twinkling', function(d) {
      var newd = mappedJson[d.properties.kioskId];
      var hasChanged = newd._source.properties.bikesAvailable != d.properties.bikesAvailable;

      d.properties.bikesAvailable = newd._source.properties.bikesAvailable;

      return hasChanged;
    });
}


</script>
</body>
</html>